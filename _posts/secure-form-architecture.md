---
title: 'セキュアなフォーム画面の入力体験を考える'
excerpt: ''
emoji: 'hand'
date: '2023.4.22'
tags: 'security,ui/ux'
ogImage:
  url: ''
---

## 背景
保険金を請求するフォーム画面の開発プロジェクトに関わった。  
ドメインが保険金の請求のため、扱う情報は機密性が高く、高いセキュリティ要件が必要になるはずだったが、
実際の仕様としては以下の形に落ち着いた。

- 導線はモバイルアプリからのWebへの画面遷移で、リダイレクトで画面表示する
- そのような導線のためログイン機能は存在しなかったが、なぜかセッション管理も存在しなかった
- 初期画面表示ではユーザー情報や請求に必要なIDを取得するためのトークンがURLに付与されてくるので、そのトークンを使用して、請求IDとユーザー情報を取得する
- 画面入力 -> 入力内容確認画面を経て、請求確定ボタンを押すと、請求IDと入力情報をサーバーに投げて請求完了

上記の通りセキュアでないポイントが多々あったが、バックエンド&インフラは協力会社の方で管理されていた上、こちらから口出しできない&仕様変更の依頼も許可されていない状態のため、ユーザビリティやセキュリティの面で
妥協したポイントがいくつかあった。  
これを~反面教師~反省として活かすため、今回のアプリケーションは本来どのように設計すべきであったかを書き留めておこうと思う。

## セッションの必要性

セッションとは何か、再度確認しておく。

```
Web セッションは、同じユーザーに関連付けられた一連のネットワーク HTTP 要求および応答トランザクションです。
```

HTTPはステートレスのため、全てのリクエストに対し、どのユーザーからの情報なのかをリクエストに付与し、サーバー側で判断する必要がある。
例えば、ユーザーに紐づくID（SessionID）をCookieに持っておくなど。

つまり、ユーザーを判別し、またユーザー状態の追跡（ショッピングカートやアプリケーション内でのユーザーの選択など、ユーザー状態を追跡してサーバー側で管理）などにセッションを用いる。  
逆に言うと、これらの必要性がない場合は、サーバー側でセッション管理する必要性は薄くなる。

### 今回のアプリケーションにセッションは必要か？

以下2点の理由で必要と考える。

- フォーム画面のリロード時のユーザービリティ
- セッションタイムアウト

### フォーム画面のリロード時のユーザービリティ
フォーム画面の入力中の情報は、特に何もしなければ画面のリフレッシュによって消えてしまう。  
入力画面の途中であれば入力し直すこと自体は問題ではないが、問題は入力内容確定画面にある。  
入力画面 -> 入力内容確定画面 への遷移で、ユーザー側のアクションとしてはボタンを押下し、情報の確定操作を行なっている。（情報としてはユーザーが一定納得感を持って、入力を終えたもの、というステータス）
その情報が、誤操作でも画面リロードしただけで全て失われてしまうのは、ユーザーにとってストレスに感じる部分のように思う。  
つまり、ユーザーが請求完了するまでの途中段階で、少なくとも確定画面では画面リロード後も入力内容は保持されてほしい。

フォームの入力内容を保持する手段として、以下の方法が考えられる。
- ブラウザのストレージ（localStorage / sessionStorage）
- URLのクエリパラメータ
- サーバーのストレージ

今回は機密性の高い情報を扱うこともあり、ブラウザ側での保持はセキュリティリスクになりうるため、サーバー側でストレージを持つ方向で考えるべき。

その際に、**「入力途中データ」というユーザー固有のデータを、セッションで管理すべき**と考える。  
セッションIDと紐づく形で入力途中の情報を保持しておけば、セッションが無効になったタイミングで入力情報も破棄することができ、入力途中データのゴミデータの削除サイクルを考える必要もない。  
画面がリロードされた際は、セッションIDに紐づく入力画面の存在を確認し、データがあれば入力項目に初期設定するといった形で、ユーザーが確認画面まで操作した情報を失わずに済む。

> ※ プロジェクトでは、バックエンド側でユーザーセッションを管理するような実装になっていなかったため、リロード時にデータを復元する機能を作ることができず、結局リロードした際はエラー画面に飛ばすといった、ユーザビリティのよろしくない作りとなってしまった。。

### セッションタイムアウト

機密性の高い情報をユーザーに入力させる場合、セッションタイムアウトを設定することがセキュリティ上望ましいとされる。セッションタイムアウトは、一定時間の無操作状態が続いた場合に、自動的にユーザーのセッションを終了させることができ、これにより、放置された端末からの不正アクセスや情報漏洩のリスクを軽減することができる。

そして、このセッションタイムアウトは**原則バックエンド側で実施すべき**である。  
ブラウザ側（クライアントサイド）のみでタイムアウトを管理する場合、悪意あるユーザーや攻撃者がJavaScriptを無効化したり、ブラウザの開発者ツールを使用してタイムアウトを回避することが可能になるリスクがある。

> ※ プロジェクトでは、クライアント側で時間を計測して、指定の時間経過を検知するとエラー画面に遷移させるといった、擬似タイムアウトを行なっていた。。


## SQLインジェクション対策

バックエンドの仕様変更が許されていなかったものの、バックエンド側でSQLインジェクション対策が実装されていなかった。  
そのためフロントエンド側で行う（？）こととなった。

JavaScriptにて行う処理は、minifyされていようと基本的にユーザーが書き換えて実行可能なため、SQLインジェクション対策のようなセキュリティに関わる実装をフロントエンドで行うべきではない。




