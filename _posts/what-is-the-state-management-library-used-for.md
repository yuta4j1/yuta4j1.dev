---
title: '何のために状態管理ライブラリを使用するのか'
excerpt: ''
coverImage: '/assets/blog/hello-world/cover.jpg'
emoji: 'pencil'
date: '2023.4.1'
tags: 'web frontend'
ogImage:
  url: '/assets/blog/hello-world/cover.jpg'
---

状態管理ライブラリをどのように使用すべきかはこれまで議論され尽くしていると思うが、現時点での自分の考えを書いてみる。

## TL;DR

- レンダリングのパフォーマンス
- ステートの適切な責務配置


## 状態管理ライブラリとは？
主にUIライブラリの外側で管理される状態の管理機構を指す。  
Reduxに始まり、 Recoil, jotai, Zustand などがある。  


## 状態管理ライブラリの必要性
まず、一般的に言われている状態管理ライブラリの必要性について確認する。
今から多くの文献を引っ張ってくるのが面倒なので、ChatGPT先生に聞いてみる。  
以下、ChatGPT(GPT-4)から受けた回答。


> 状態管理ライブラリは、ReactなどのUIライブラリにおいてアプリケーションの状態を管理するために役立ちます。アプリケーションが成長すると、状態管理が複雑になることがよくあります。以下に、状態管理ライブラリが必要になる理由をいくつか挙げます。
> 1. 大規模なアプリケーションの状態管理：
アプリケーションが大規模になると、状態を管理するのが難しくなります。状態管理ライブラリは、アプリケーション全体で状態を一元化し、一貫性のあるアクセスと更新を可能にします。
> 2. コンポーネント間での状態の共有：
複数のコンポーネント間で状態を共有する必要がある場合、状態管理ライブラリは役立ちます。これにより、状態の同期や変更の伝播を効果的に行うことができます。
> 3. アプリケーションロジックの分離：
状態管理ライブラリは、アプリケーションの状態とロジックをUIコンポーネントから分離するのに役立ちます。これにより、コードの再利用性とメンテナンス性が向上します。
> 4. 開発者ツールとの統合：
一部の状態管理ライブラリ（Reduxなど）は、開発者ツールと統合されており、デバッグや開発中の状態管理を容易にします。
> 5. より良いパフォーマンスのための最適化：
状態管理ライブラリを使用することで、状態の変更に応じて特定のコンポーネントのみを効率的に再描画することができます。
>
> ただし、状態管理ライブラリは必ずしもすべてのアプリケーションに適しているわけではありません。小規模なアプリケーションや単純な状態管理が必要な場合は、Reactのローカル状態やコンテクストAPIを使用する方が適切かもしれません。状態管理ライブラリは、適切な状況で使用することで効果を発揮します。


```1. 大規模なアプリケーションの状態管理``` に関して、```アプリケーション全体で状態を一元化```と```一貫性のあるアクセスと更新```については、コンポーネントに持つステート設計次第である。むしろ大規模になった場合に考える必要があるのは巨大なコンポーネントツリーの再描画パフォーマンスで、そういう文脈で状態管理ライブラリが必要になってくる。

```2. コンポーネント間での状態の共有```は正しいが、ルートに状態を持てば、UIライブラリで事足りる。

```3. アプリケーションロジックの分離```についても正しいが、状態とロジックを分離することに関しては状態管理ライブラリ関係なく、コンポーネント設計で行う必要がある。

```4. 開発者ツールとの統合``` これは確かに。

```5. より良いパフォーマンスのための最適化``` 5番目に初めてパフォーマンスの話が出てきたが、個人的にはパフォーマンス問題が最も状態管理ライブラリが必要とされている部分だと思っている。


## UIライブラリのパフォーマンス問題

UIライブラリには通常、コンポーネント内で状態を管理できる。  
また、親コンポーネント -> 子コンポーネントへ状態の受け渡しができるので、基本的に状態管理ライブラリを使用せずとも、
融通する必要のあるデータを全てルートコンポーネントに持ってしまいさえすれば、アプリケーション全体の状態を管理することができる。  

ただし、コンポーネントツリーが大きくなり、多くのコンポーネントにpropsを受け渡す必要が出てくる場合、管理するステートの配下のコンポーネント全てが再描画される。  

問題は、再描画されてほしくないコンポーネントも全て再描画がかかってしまうことにある。

例えばコンポーネントAとコンポーネントEがあり、コンポーネントAでの入力値変更がコンポーネントEに反映されて欲しいケースは珍しくない。

その場合に、以下のツリーだとどうしてもルートに共通の状態を持つ必要が出てくるが、そうすると更新時のコンポーネント描画のコストが、コンポーネントが多くなるにつれ大きくなっていく。


**このパフォーマンス問題を解消するのが状態管理ライブラリ**で、状態をライブラリ側（UIライブラリの外側）で管理することで、状態が変更した際の描画を、その管理している状態に依存しているUIコンポーネントのみにとどめることができる。

## 状態の責務

親コンポーネントに状態を持ちすぎるとパフォーマンスの問題のみでなく、
- 親コンポーネントに保持する状態が膨大になる
- 子コンポーネントに直接関係のないpropsがリレーされる

など、コードの見通しなども悪くなる。  
状態管理ライブラリで管理している値は、必要なコンポーネントから直接参照されるだけなので、そのような問題も解消される。

## とはいえ、必須ではない

先述しているが、状態管理ライブラリを導入しないとアプリケーションが完成しないことは殆ど無く、パフォーマンス問題や状態の責務の問題を度外視すれば、基本的に必要のないものである。

また状態の責務に関して言えば、例えばReactだとContext APIを使用すれば、propsのバケツリレーを抑えることができる。（パフォーマンス問題は解消されない。）

そのため、やはり使用するモチベーションとしては描画パフォーマンスの最適化のためのものであり、一定の規模のアプリケーションにしか必要ではないのではないか、という結論。